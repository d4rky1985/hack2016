{% extends '::base.html.twig' %}

{% block page %}
    <div data-role="page" class="jqm-demos jqm-home" id="page_index" class="page_index">

        {% include '::includes/header.html.twig' %}
        <div role="main" class="ui-content jqm-content">
            <form class="ui-filterable">
                <fieldset class="ui-grid-b">
                    <div class="ui-block-b" style="width: 75%; margin-top:3px;">
                        <input id="autocomplete-input" data-type="search" placeholder="Add a product...">
                    </div>
                    <div class="ui-block-c" style="width: 25%">
                        <div align="right">
                            <a href="#" class="ui-btn ui-btn-inline ui-icon-arrow-d ui-btn-icon-right" id="add-product">add</a>
                        </div>
                    </div>
                </fieldset>


            </form>
            <ul id="autocomplete" data-role="listview" data-inset="true" data-filter="true" data-input="#autocomplete-input"></ul>
        </div><!-- /content -->
        {% include '::includes/menu.html.twig' %}
        {% include '::includes/footer.html.twig' %}

        <script language="JavaScript">
            $( document ).on( "pagecreate", "#page_index", function() {
                $("#autocomplete").on("filterablebeforefilter", function (e, data) {
                    var $ul = $(this),
                            $input = $(data.input),
                            value = $input.val(),
                            html = "";
                    $ul.html("");
                    if ( value && value.length > 2 ) {
                        $ul.html( "<li><div class='ui-loader'><span class='ui-icon ui-icon-loading'></span></div></li>" );
                        $ul.listview( "refresh" );
                        $.ajax({
                            method: "POST",
                            url: "{{ path('shopping_search_products_default') }}",
                            dataType: "json",
                            data: {
                                product: $input.val()
                            }
                        }).then( function ( response ) {
                            $.each( response, function ( i, val ) {
                                html += "<li><a href='#' class='add-product-to-list'>" + val.name + "</a></li>";
                            });
                            $ul.html( html );
                            $ul.listview( "refresh" );
                            $ul.trigger( "updatelayout");
                        });
                    }
                });

                $('#add-product').click(function() {
                    addProduct($('#autocomplete-input').val().trim());
                });
                $(document).on('click', ".add-product-to-list", function(){
                    addProduct($(this).html().trim());
                });

                function addProduct(product) {
                    if (product.length > 0) {
                        $.ajax({
                            method: "POST",
                            url: "{{ path('shopping_list_add_product_ajax') }}",
                            dataType: "json",
                            data: { product: product }
                        }).then( function ( response ) {
                            console.log(response);
                        });
                    }
                }
            });
        </script>

    </div><!-- /page -->

{% endblock %}
