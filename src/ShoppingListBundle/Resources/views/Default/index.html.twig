{% extends '::base.html.twig' %}

{% block page %}
    <div data-role="page" class="jqm-demos jqm-home" id="page_index" class="page_index">

        {% include '::includes/header.html.twig' %}
        <div role="main" class="ui-content jqm-content">
            <form class="ui-filterable">
                <fieldset class="ui-grid-b">
                    <div class="ui-block-b" style="width: 75%; margin-top:3px;">
                        <input id="autocomplete-input" data-type="search" placeholder="Add a product...">
                    </div>
                    <div class="ui-block-c" style="width: 25%">
                        <div align="right">
                            <a href="#" class="ui-btn ui-btn-inline ui-icon-arrow-d ui-btn-icon-right" id="add-product">add</a>
                        </div>
                    </div>
                </fieldset>


            </form>
            <ul id="autocomplete" data-role="listview" data-inset="true" data-filter="true" data-input="#autocomplete-input"></ul>


            <a href="#popupProduct"
               data-inline="true"
               data-role="button"
               data-position-to="window"
               data-rel="popup"
               aria-haspopup="true"
               aria-owns="popupLogin"
               aria-expanded="false"
               class="ui-link ui-btn ui-btn-inline ui-shadow ui-corner-all"
               role="button">Form</a>

            <div data-theme="a" id="popupProduct" data-role="popup" data-overlay-theme="a" class="ui-content">
                <div style="padding:20px">
                    <p>Cum ti-ar sta cu palarie?</p>
                    <p><img src="https://s0emagst.akamaized.net/products/3888/3887197/images/res_9e1c595489d192168d4c10d8244f91c2_450x450_100_70jc.jpg" width="200"></p>
                    <a href="http://m.emag.ro/palarie-kangol-sweetcorn-siren-mov-m-6927bcb2/pd/D9G9D2BBM/" class="ui-btn ui-btn-b ui-shadow ui-corner-all">Buy now</a>
                    <a href="" id="btnPopupAddProduct" class="ui-btn ui-btn-b ui-shadow ui-corner-all">Add to wish list</a>
                    <a href="" id="btnPopupClose" class="ui-btn ui-btn-b ui-shadow ui-corner-all">No, thank you!</a>
                </div>
            </div>

            <div id="popupError" class="ui-content" data-role="popup" data-theme="a">
                <p>Sorry! An error occured.</p>
                <div class="ui-grid-a">
                    <div class="ui-block-a">
                        <a href="ok" id="ok" class="ui-btn ui-corner-all ui-mini ui-btn-a" data-rel="back">Ok</a>
                    </div>
                </div>
            </div>


        </div><!-- /content -->
        {% include '::includes/menu.html.twig' %}
        {% include '::includes/footer.html.twig' %}

        <script language="JavaScript">
            $( document ).on( "pagecreate", "#page_index", function() {
                $("#autocomplete").on("filterablebeforefilter", function (e, data) {
                    var $ul = $(this),
                            $input = $(data.input),
                            value = $input.val(),
                            html = "";
                    $ul.html("");
                    if ( value && value.length > 2 ) {
                        $ul.html( "<li><div class='ui-loader'><span class='ui-icon ui-icon-loading'></span></div></li>" );
                        $ul.listview( "refresh" );
                        $.ajax({
                            method: "POST",
                            url: "{{ path('shopping_search_products_default') }}",
                            dataType: "json",
                            data: {
                                product: $input.val()
                            }
                        }).then( function ( response ) {
                            $.each( response, function ( i, val ) {
                                html += "<li><a href='#'>" + val.name + "</a></li>";
                            });
                            $ul.html( html );
                            $ul.listview( "refresh" );
                            $ul.trigger( "updatelayout");
                        });
                    }
                });

                $('#add-product').click(function() {
                    addProduct($('#autocomplete-input').val().trim());
                });

                function addProduct(product) {
                    if (product.length > 0) {
                        $.ajax({
                            method: "POST",
                            url: "{{ path('shopping_list_add_product_ajax') }}",
                            dataType: "json",
                            data: { product: product }
                        }).then( function ( response ) {
                            console.log(response);
                        });
                    }
                }

                $('#btnPopupClose').on('click', function(e){
                    e.preventDefault();
                    $('#popupProduct').popup('close');
                });

                $('#btnPopupAddProduct').on('click', function(e) {
                    e.preventDefault();
                    $.mobile.loading('show');
                    $.post(Routing.generate('shopping_list_add_product_ajax', { productId: {{ productId }} }))
                        .done(function () {
                            $.mobile.loading('hide');
                            $('#popupProduct').popup('close');
                        })
                        .fail(function() {
                            $.mobile.loading('hide');
                            $('#popupProduct').popup('close');
                            $('#popupError').delay(500).popup('open');
                        });
                });

            });
        </script>

    </div><!-- /page -->

{% endblock %}
